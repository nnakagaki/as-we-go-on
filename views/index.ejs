<html>
  <head>
    <meta name="google-signin-client_id" content="<%= googleClientId %>">
    <link rel="stylesheet" href="css/sample.css">
    <link rel="stylesheet" media="screen" href="//d14pr3cu5atb0x.cloudfront.net/pkg/css/chimera-1e92aa15dc.css">
    <link rel="stylesheet" media="screen" href="//d14pr3cu5atb0x.cloudfront.net/pkg/css/icons-f9e2932681.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/vendor/turn.min.js"></script>
    <script type="text/javascript" src="js/vendor/zoom.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="js/vendor/paper-full.min.js"></script>
    <script type="text/javascript" src="js/vendor/lodash.min.js"></script>
  </head>
  <body class="container-fluid no-overflow">
    <div class="js-sidebar yearbook-index-sidebar hide-when-sm hide-when-md hide-when-lg col-xlg-2 full-height overflow-auto inverted">
      <div class="h3">Table of contents</div>
      <div>
        <a class="js-go-to-page link-inverted" data-page="3">Cat</a>
      </div>
      <div>
        <a class="js-go-to-page link-inverted" data-page="4">Wave</a>
      </div>
      <div>
        <a class="js-go-to-page link-inverted" data-page="12">Something</a>
      </div>
    </div>
    <div class="js-main col-sm-12 col-xlg-10 full-height overflow-auto">
      <div class="h2 text-center margin-top-2 margin-bottom-4">
        <span class="logo logo-color logo-text gh-logo-img"></span>
      </div>
      <div class="js-google-signin google-signin">
        <div class="js-google-signin-button g-signin2" data-onsuccess="onSignIn"></div>
      </div>
      <div class="text-center margin-bottom-5">
        <button class="js-fullscreen button">FULLLLSCREAAAAYYYYN</button>
        <button class="js-draw button">DRAWWWWWW</button>
        <button class="js-flip button is-hidden">FLIPPPPPP</button>
      </div>
      <div class="display-flex horizontal-center-flex-container">
        <div id="js-zoom-wrap" class="flipbook-wrap transparent-background make-relative">
          <canvas id="js-left-canvas" class="drawing-canvas-1 is-hidden" height="594" width="420"></canvas>
          <canvas id="js-right-canvas" class="drawing-canvas-2 is-hidden" height="594" width="420"></canvas>
          <div id="js-flipbook" class="flipbook">
            <div class="hard"> Animoto: Class of 2017 </div>
            <div class="hard front-side"><div class="depth"></div></div>
            <%- include('partials/page', { pageNum : 3, imageSrc : "https://static.pexels.com/photos/45201/kitty-cat-kitten-pet-45201.jpeg" }) %>
            <%- include('partials/page', { pageNum : 4, imageSrc : "images/test_1.jpg" }) %>
            <%- include('partials/page', { pageNum : 5, imageSrc : "images/test_2.jpg" }) %>
            <%- include('partials/page', { pageNum : 6, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 7, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 8, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 9, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 10, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 11, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 12, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 13, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 14, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 15, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 16, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 17, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 18, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 19, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 20, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 21, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 22, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 23, imageSrc : '' }) %>
            <%- include('partials/page', { pageNum : 24, imageSrc : '' }) %>
            <div class="hard fixed back-side"><div class="depth"></div></div>
            <div class="hard"></div>
          </div>
        </div>
      </div><div id="js-slider" class="page-slider margin-top-4 margin-bottom-6">
      </div>
      <div class="pull-right">
        <a href="//www.iubenda.com/privacy-policy/8279875" class="iubenda-white iubenda-embed" title="Privacy Policy">Privacy Policy</a>
        <script type="text/javascript">(function (w, d) { var loader = function () { var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src = "//cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s, tag); }; if (w.addEventListener) { w.addEventListener("load", loader, false); } else if (w.attachEvent) { w.attachEvent("onload", loader); } else { w.onload = loader; } })(window, document);</script>
      </div>
    </div>
  </body>
  <script>
    baseOuterWidth = 440;
    baseOuterHeight = 307;
    baseInnerWidth = 420;
    baseInnerHeight = 297;
    isFullScreen = false;
    currentOuterWidth = baseOuterWidth * 2;
    currentOuterHeight = baseOuterHeight * 2;

    zoomWrap = $('#js-zoom-wrap');
    flipbook = $("#js-flipbook");
    slider = $('#js-slider');

    zoomWrap.css({ width : baseOuterWidth * 2 });
    slider.css({ width : baseOuterWidth });

    addStrokesToPageCanvas = function(pageNum) {
      var pageStrokes = _.filter(allStrokes, function(stroke) { return stroke.page === pageNum; }),
          canvas = document.getElementById('js-canvas-page-' + pageNum);

      paper.setup(canvas);
      pageStrokes.forEach(function(stroke) {
        var path = new paper.Path();
        path.importJSON(stroke.stroke);
      });
    };

    $.ajax({
      url     : '/strokes',
      success : function(res) {
        allStrokes = res;
        for (var i = 2; i < flipbook.turn('pages') - 2; i++) {
          addStrokesToPageCanvas(i);
        }
      }
    });

    flipbook.turn({
      width      : baseOuterWidth * 2,
      height     : baseOuterHeight * 2,
      elevation  : 50,
      autoCenter : true,
      when       : {
        turning : function (e, page, view) {
          var book = $(this)
          if (page >= 2) {
            $('.hard.front-side').addClass('fixed');
          }
          else {
            $('.hard.front-side').removeClass('fixed');
          }
          if (page < book.turn('pages')) {
            $('.hard.back-side').addClass('fixed');
          }
          else {
            $('.hard.back-side').removeClass('fixed');
          }
        }
      }
    });

    slider.slider({
      min    : 1,
      max    : flipbook.turn("pages"),
      change : function(e, ui) {
        flipbook.turn('page', ui.value)
      }
    });

    flipbook.on('turned', function(event, page, view) {
      slider.slider('value', page);
    });

    flipbook.on('start', function(event, page, view) {
      if (isFullScreen) {
        var newHeight = screen.height;
        var outerRatio = screen.height / currentOuterHeight;
        var newOuterWidth = (currentOuterWidth) * outerRatio;
        var innerRatio = screen.height / baseInnerHeight;
        var newInnerWidth = baseInnerWidth * innerRatio;
        var newInnerHeight = baseInnerHeight * innerRatio;
        $('.own-size').css({
          width  : newInnerWidth / 2 - 20,
          height : newInnerHeight - 20
        });
        $('.depth').css({
          height : newHeight - 10,
          width  : 25
        });
        flipbook.turn('size', newOuterWidth, newHeight);
      }
    });

    $('.js-zoom-in').on('click', function() {
      if (zoomWrap.width() < baseOuterWidth * 2.7) {
        var newWidth = zoomWrap.width() + baseOuterWidth * 0.5;
        var newHeight = zoomWrap.height() + baseOuterHeight * 0.5;
        zoomWrap.css({ width : newWidth })
        flipbook.turn('size', newWidth, newHeight);
      }
    });
    $('.js-zoom-out').on('click', function() {
      if (zoomWrap.width() > baseOuterWidth) {
        var newWidth = zoomWrap.width() - baseOuterWidth * 0.5;
        var newHeight = zoomWrap.height() - baseOuterHeight * 0.5;
        zoomWrap.css({ width : newWidth })
        flipbook.turn('size', newWidth, newHeight);
      }
    });
    $(document).on('keyup', function(e) {
      if (e.which === 39) {
        flipbook.turn('next');
      } else if (e.which === 37) {
        flipbook.turn('previous');
      }
    });
    $('.js-fullscreen').on('click', function() {
      req = zoomWrap[0].requestFullScreen || zoomWrap[0].webkitRequestFullScreen || zoomWrap[0].mozRequestFullScreen;

      currentOuterWidth = zoomWrap.width();
      currentOuterHeight = zoomWrap.height();

      var newHeight = screen.height;
      var outerRatio = screen.height / currentOuterHeight;
      var newOuterWidth = (currentOuterWidth) * outerRatio;
      var innerRatio = screen.height / baseInnerHeight;
      var newInnerWidth = baseInnerWidth * innerRatio;
      var newInnerHeight = baseInnerHeight * innerRatio;
      $('.own-size').css({
        width  : newInnerWidth / 2 - 20,
        height : newInnerHeight - 20
      });
      $('.depth').css({
        height : newHeight - 10,
        width  : 25
      });
      zoomWrap.css({ width: newOuterWidth });
      flipbook.turn('size', newOuterWidth, newHeight);

      req.call(zoomWrap[0]);
    });

    onFullscreenChangeHandler = function() {
      if (isFullScreen) {
        zoomWrap.css({ width : currentOuterWidth });
        $('.own-size').css({
          width  : baseInnerWidth,
          height : baseInnerHeight * 2
        });
        $('.depth').css({
          height : 604,
          width  : 16
        })
        flipbook.turn('size', currentOuterWidth, currentOuterHeight);
        isFullScreen = false;
      } else {
        isFullScreen = true;
      }
    }

    document.addEventListener('fullscreenchange', onFullscreenChangeHandler);
    document.addEventListener('webkitfullscreenchange', onFullscreenChangeHandler);
    document.addEventListener('mozfullscreenchange', onFullscreenChangeHandler);
    document.addEventListener('MSFullscreenChange', onFullscreenChangeHandler);

    onSignIn = function(googleUser) {
      var profile = googleUser.getBasicProfile();
      $('.js-google-signin').append('<img class="google-signed-in-image" src="' + profile.getImageUrl() + '" />')
      $('.js-google-signin-button').addClass('is-hidden');
      console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
      console.log('Name: ' + profile.getName());
      console.log('Image URL: ' + profile.getImageUrl());
      console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
    }

    $('.js-draw').on('click', function() {
      flipbook.turn('disable', true);
      $('#js-left-canvas').removeClass('is-hidden');
      $('#js-right-canvas').removeClass('is-hidden');
      $('.js-flip').removeClass('is-hidden');
      $('.js-draw').addClass('is-hidden');
    });

    $('.js-flip').on('click', function() {
      flipbook.turn('disable', false);
      $('#js-left-canvas').addClass('is-hidden');
      $('#js-right-canvas').addClass('is-hidden');
      $('.js-flip').addClass('is-hidden');
      $('.js-draw').removeClass('is-hidden');
    });

    $('.js-go-to-page').on('click', function(e) {
      var page = $(e.currentTarget).data('page');
      flipbook.turn('page', page);
    })

    saveLeft = function() {
      var canvas = document.getElementById("js-left-canvas");
      canvas.toBlob(function(blob) {
        saveAs(blob, "lol.png");
      });
    }

    saveRight = function() {
      var canvas = document.getElementById("js-right-canvas");
      canvas.toBlob(function(blob) {
        saveAs(blob, "pretty image.png");
      });
    }
  </script>
  <script type="text/paperscript" src="js/canvas.js" canvas="js-left-canvas"></script>
  <script type="text/paperscript" src="js/canvas.js" canvas="js-right-canvas"></script>
</html>